<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8" />
    <title>Kickass Chat</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="signalr.min.js"></script>
</head>
<body>
    <div class="chat-container">
        <h2>چت خصوصی</h2>
        <div id="chat-box" class="chat-box"></div>
        <div class="form">
            <div id="messageInput"
                 contenteditable="true"
                 placeholder="پیام خود را بنویسید..."
                 class="editable"></div>
            <button onclick="sendMessage()">ارسال</button>
        </div>
    </div>

    <script>
        const token = localStorage.getItem("chat-token");
        if (!token) {
            window.location.href = "login.html";
        }

        let userName = "";
        let roomName = "";

        fetch("/auth/GetMe", {
            method: "GET",
            headers: {
                "Authorization": token
            }
        })
        .then(res => {
            if (!res.ok) throw new Error("توکن نامعتبر است");
            return res.json();
        })
        .then(data => {
            userName = data.userName;
            roomName = data.roomName;
            startChat(userName, roomName);
        })
        .catch(err => {
            alert("خطای احراز هویت: " + err.message);
            window.location.href = "index.html";
        });

        function startChat(userName, roomName) {
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/chathub", {
                    accessTokenFactory: () => token
                })
                .build();

            connection.on("ReceiveMessage", (userName, message, time) => {
                const msgDiv = document.createElement("div");
                msgDiv.classList.add("message");
                msgDiv.innerHTML = `<strong>${userName}</strong> <span class="time">[${time}]</span>: ${message}`;
                document.getElementById("chat-box").appendChild(msgDiv);
                msgDiv.scrollIntoView({ behavior: 'smooth' });
            });

            connection.start()
                .then(() => connection.invoke("JoinRoom", roomName))
                .catch(err => {
                    alert("اتصال ناموفق");
                    console.error(err);
                });

            window.sendMessage = function () {
                const div = document.getElementById("messageInput");
                const message = div.innerText.trim();

                if (!message) return;

                const now = new Date();
                const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                connection.invoke("SendMessage", userName, message, time, roomName);
                div.innerText = '';
            }
        }
    </script>
</body>
</html>
